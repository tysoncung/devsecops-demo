name: Security Scan (Simplified)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ESLint Security Check
  eslint-security:
    name: ESLint Security Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run ESLint
        run: npm run lint || true
      
      - name: Generate ESLint Report
        run: |
          npm run lint -- --format json --output-file eslint-report.json || true
          echo "### ESLint Security Report" >> $GITHUB_STEP_SUMMARY
          echo "ESLint found security issues in the code (intentional for demo)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ This is expected - the code contains intentional vulnerabilities for demonstration" >> $GITHUB_STEP_SUMMARY

  # Secret Detection
  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true
      
      - name: Secret Scan Summary
        if: always()
        run: |
          echo "### 🔐 Secret Detection Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.gitleaks.outcome }}" == "failure" ]; then
            echo "⚠️ **Secrets Detected** (intentional for demo)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Found hardcoded credentials in the code:" >> $GITHUB_STEP_SUMMARY
            echo "- API Keys" >> $GITHUB_STEP_SUMMARY
            echo "- Passwords" >> $GITHUB_STEP_SUMMARY
            echo "- AWS Secrets" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ This is expected - demonstrating secret detection capabilities" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ No secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

  # CodeQL Analysis
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v3
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        continue-on-error: true

  # Dependency Audit
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run npm audit
        id: npm_audit
        continue-on-error: true
        run: |
          npm audit --audit-level=moderate 2>&1 | tee audit-results.txt || true
          
      - name: Generate Audit Summary
        if: always()
        run: |
          echo "### 📦 Dependency Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if grep -q "found 0 vulnerabilities" audit-results.txt 2>/dev/null; then
            echo "✅ No vulnerabilities found in dependencies" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Vulnerabilities found in dependencies**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm audit\` locally to see details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This is expected for the demo - showing dependency scanning capabilities" >> $GITHUB_STEP_SUMMARY
          fi

  # Semgrep SAST
  semgrep:
    name: Semgrep SAST Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        continue-on-error: true
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten
            p/javascript

  # Docker Security Scan
  docker-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Create healthcheck file
        run: |
          cat << 'EOF' > healthcheck.js
          console.log('Health check');
          process.exit(0);
          EOF
      
      - name: Build Docker image
        run: docker build -t devsecops-demo:${{ github.sha }} .
      
      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: devsecops-demo:${{ github.sha }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
      
      - name: Container Scan Summary
        if: always()
        run: |
          echo "### Container Security Report" >> $GITHUB_STEP_SUMMARY
          echo "Trivy scanned the Docker image for vulnerabilities" >> $GITHUB_STEP_SUMMARY

  # Final Security Summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [eslint-security, secret-detection, codeql, dependency-audit, semgrep, docker-security]
    if: always()
    steps:
      - name: Generate Final Report
        run: |
          echo "# 🔒 DevSecOps Security Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Security Scans Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Purpose | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | Code quality & security | ✅ Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Gitleaks | Secret detection | ✅ Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | Advanced SAST | ✅ Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| npm audit | Dependency vulnerabilities | ✅ Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Semgrep | Pattern-based SAST | ✅ Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy | Container security | ✅ Completed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 📝 Note" >> $GITHUB_STEP_SUMMARY
          echo "This repository contains **intentional vulnerabilities** for demonstration purposes." >> $GITHUB_STEP_SUMMARY
          echo "All security findings are expected and part of the DevSecOps training material." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Pipeline Status:** All security checks ran successfully!" >> $GITHUB_STEP_SUMMARY