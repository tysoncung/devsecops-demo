name: Security Scan (Simplified)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ESLint Security Check
  eslint-security:
    name: ESLint Security Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run ESLint
        run: npm run lint || true
      
      - name: Generate ESLint Report
        run: |
          npm run lint -- --format json --output-file eslint-report.json || true
          echo "### ESLint Security Report" >> $GITHUB_STEP_SUMMARY
          echo "ESLint found security issues in the code (intentional for demo)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… This is expected - the code contains intentional vulnerabilities for demonstration" >> $GITHUB_STEP_SUMMARY

  # Secret Detection
  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Secret Scan Summary
        if: always()
        run: |
          echo "### Secret Detection Report" >> $GITHUB_STEP_SUMMARY
          echo "Gitleaks scanned for hardcoded secrets and credentials" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Found hardcoded secrets (intentional for demo purposes)" >> $GITHUB_STEP_SUMMARY

  # CodeQL Analysis
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v3
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        continue-on-error: true

  # Dependency Audit
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || true
          echo "### Dependency Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "npm audit checked for vulnerable dependencies" >> $GITHUB_STEP_SUMMARY
      
      - name: Check with Snyk (if token available)
        if: ${{ secrets.SNYK_TOKEN != '' }}
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  # Semgrep SAST
  semgrep:
    name: Semgrep SAST Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        continue-on-error: true
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten
            p/javascript

  # Docker Security Scan
  docker-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Create healthcheck file
        run: |
          cat << 'EOF' > healthcheck.js
          console.log('Health check');
          process.exit(0);
          EOF
      
      - name: Build Docker image
        run: docker build -t devsecops-demo:${{ github.sha }} .
      
      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: devsecops-demo:${{ github.sha }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
      
      - name: Container Scan Summary
        if: always()
        run: |
          echo "### Container Security Report" >> $GITHUB_STEP_SUMMARY
          echo "Trivy scanned the Docker image for vulnerabilities" >> $GITHUB_STEP_SUMMARY

  # Final Security Summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [eslint-security, secret-detection, codeql, dependency-audit, semgrep, docker-security]
    if: always()
    steps:
      - name: Generate Final Report
        run: |
          echo "# ðŸ”’ DevSecOps Security Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Security Scans Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Purpose | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | Code quality & security | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Gitleaks | Secret detection | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | Advanced SAST | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| npm audit | Dependency vulnerabilities | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Semgrep | Pattern-based SAST | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy | Container security | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Note" >> $GITHUB_STEP_SUMMARY
          echo "This repository contains **intentional vulnerabilities** for demonstration purposes." >> $GITHUB_STEP_SUMMARY
          echo "All security findings are expected and part of the DevSecOps training material." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Pipeline Status:** All security checks ran successfully!" >> $GITHUB_STEP_SUMMARY