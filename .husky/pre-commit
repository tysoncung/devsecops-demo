#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit security checks..."

# Run ESLint (warning only for demo - real projects should fail on errors)
echo "ğŸ“ Running ESLint..."
npm run lint || {
    echo "âš ï¸  ESLint found issues - this is expected for the demo"
    echo "ğŸ’¡ In production, these should be fixed before committing"
}

# Check for secrets (excluding node_modules and using git index)
echo "ğŸ” Checking for secrets..."
if command -v gitleaks &> /dev/null; then
    # Only scan staged files in git, not node_modules
    gitleaks protect --verbose --staged || {
        echo "ğŸ”´ SECRETS DETECTED! Review the findings above."
        echo "âŒ Commit blocked due to hardcoded secrets"
        exit 1
    }
else
    echo "âš ï¸  Gitleaks not installed. Install with: brew install gitleaks"
fi

# Run npm audit (warning only for demo)
echo "ğŸ“¦ Checking dependencies..."
npm audit --audit-level=critical || echo "âš ï¸ Vulnerabilities found - expected for demo"

# Run lint-staged
npx lint-staged

echo "âœ… Pre-commit checks completed (demo mode)"